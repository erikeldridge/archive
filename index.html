<button disabled="true">click</button>
<script src="http://yui.yahooapis.com/3.1.0/build/yui/yui-min.js"></script>
<script>
//credit: http://javascript.crockford.com/remedial.html
if(!String.prototype.supplant){String.prototype.supplant=function(o){return this.replace(/{([^{}]*)}/g,function(a,b){var r=o[b];return typeof r==='string'||typeof r==='number'?r:a;});};}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"");};}

var openid = 'yahoo.com';
var oauthConsumerKey = 'examplek9TDNTVXpvRnpsbjJHJmQ9WVdrOVpXRlBkWEJETm1zbWNHbzlNQS0tJnM9Y29uc3VtZXJzZWNyZXQmeD0wYw--';
var returnTo = 'http://example.com/openid-oauth-yql-yui-party/relay.html';

var Y = YUI({
    gallery: 'gallery-2010.01.27-20'
});


Y.use('node', 'gallery-yql', function(Y) {
    
    var popup = null;
    
    function complete ( assertion ) {

        var query = ( "use 'http://gist.github.com/yql/yql-tables/raw/master/openid/openid.normalize.xml' as openid.normalize;"
            +" use 'http://example.com/openid-oauth-yql-yui-party/complete.xml' as complete;"
            +" select * from complete where oauthConsumerKey='{key}' and assert='{assert}' and normalizedOpenId='{id}' "
            +"" ).supplant({
                id: 'http://yahoo.com/',
        	    key: oauthConsumerKey, 
        	    assert: encodeURIComponent( assertion )
            });

        new Y.yql( query, function(r) {

            if ( r.error ) {
                Y.log(r);
                return;
            }

            if ( r.query.results.success ) {
                Y.fire( 'openid-oauth-yql-yui-party:success' );
            } else {
                Y.fire( 'openid-oauth-yql-yui-party:fail' );
            }
            
            popup.close();

        }, {debug:true, diagnostics:true}, {secure:true} );
    }
    
    //start
    var query = "use 'http://example.com/openid-oauth-yql-yui-party/start.xml' as table;"
        +" select * from table where openid='{id}' and oauthConsumerKey='{key}' and returnTo='{uri}'".supplant({
            id: openid,
    	    key: oauthConsumerKey,
    	    uri: returnTo
        });
    new Y.yql( query, function(r) {
        
        if ( r.error ) {
            Y.log(r);
            return;
        }
        
        Y.one('button').set('disabled', false).on( 'click', function ( e ) {
            
            popup = window.open( r.query.results.uri,

        	    //pass key & id to relay.html thru window.name
        	    'key='+oauthConsumerKey+'&id='+openid,

        	    'toolbar=0,scrollbars=1,location=1,statusbar=1,menubar=0,resizable=1,width=1000,height=500,left=200,top=200'
        	);
        	
            var interval = setInterval( function(){

                //poll popup as hacky 'listener'
                try{
                    if ( popup.location && 0 === popup.location.href.indexOf( returnTo ) ) {
                        clearInterval( interval );
                        complete( popup.location.href );  
                    }
                    if ( popup.closed ) {
                        clearInterval( interval );
                    }
                }catch(e){}
            }, 1000 );
            
        });        
    }, {debug:true, diagnostics:true}, {secure:true} );
    
    //...
    Y.on('openid-oauth-yql-yui-party:success', function() {
        Y.log('hallelujah!');
    });
    Y.on('openid-oauth-yql-yui-party:fail', function() {
        Y.log('hmmm');
    });
});
</script>